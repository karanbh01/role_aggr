<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>role/agg</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tienne:wght@400;700;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Geist&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Gelasio:wght@400;700&display=swap" rel="stylesheet">

    <script>
        // Simple JavaScript to handle initial loading state
        document.addEventListener('DOMContentLoaded', function() {
            const jobListings = document.querySelector('.job-listings');
            const initialLoadingElement = document.querySelector('.loading');

            if (jobListings && initialLoadingElement) {
                // Hide initial loading after content is loaded
                initialLoadingElement.style.display = 'none';
                jobListings.style.display = 'grid';
            }
            
            // Initialize selected text on page load
            if (document.getElementById('company-selected-text')) {
                updateSelectedText('company');
            }
            if (document.getElementById('location-selected-text')) {
                updateSelectedText('location');
            }
        });

        // Function to toggle dropdown visibility
        function toggleDropdown(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            const isVisible = dropdown.style.display === 'block';
            
            // Close all dropdowns first
            document.querySelectorAll('.dropdown-content').forEach(d => {
                d.style.display = 'none';
            });
            
            // Toggle the clicked dropdown
            dropdown.style.display = isVisible ? 'none' : 'block';

            // If opening, focus the search input and clear it
            if (dropdown.style.display === 'block') {
                const searchInput = dropdown.querySelector('.dropdown-search');
                if (searchInput) {
                    searchInput.value = ''; // Clear previous search
                    searchInput.focus();
                    filterDropdownOptions(dropdownId); // Show all options initially
                }
            } else {
                 // If closing, clear the search input and show all options
                const searchInput = dropdown.querySelector('.dropdown-search');
                if (searchInput) {
                    searchInput.value = '';
                    filterDropdownOptions(dropdownId); // Show all options
                }
            }
        }

        // Function to update selected text display
        function updateSelectedText(filterType) {
            const checkboxes = document.querySelectorAll(`input[name="${filterType}"]:checked`);
            const textElement = document.getElementById(`${filterType}-selected-text`);
            
            if (checkboxes.length === 0) {
                if (filterType === 'company') {
                    textElement.textContent = 'Select Companies';
                } else if (filterType === 'location') {
                    textElement.textContent = 'Select Locations';
                } else {
                    textElement.textContent = `Select ${filterType}`;
                }
            } else if (checkboxes.length === 1) {
                textElement.textContent = checkboxes[0].value;
            } else {
                textElement.textContent = `${checkboxes.length} selected`;
            }
        }

        // Function to clear all filters
        function clearFilters() {
            // Clear all checkboxes
            document.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.checked = false;
            });
            
            // Clear radio buttons and select "All" options (no longer used since City/Country are now checkboxes)
            document.querySelectorAll('input[type="radio"]').forEach(radio => {
                if (radio.value === '') {
                    radio.checked = true;
                } else {
                    radio.checked = false;
                }
            });
            
            // Clear dropdowns
            document.querySelectorAll('select').forEach(select => {
                select.selectedIndex = 0;
            });
            
            // Clear text inputs
            document.querySelectorAll('input[type="text"]').forEach(input => {
                input.value = '';
            });
            
            // Clear hidden inputs
            document.querySelectorAll('input[type="hidden"]').forEach(input => {
                input.value = '';
            });
            
            // Update display text
            if (document.getElementById('company-selected-text')) {
                updateSelectedText('company');
            }
            if (document.getElementById('location-selected-text')) {
                updateSelectedText('location');
            }
            updateCitySelection();
            updateCountrySelection();
            
            // Clear button group selections
            document.querySelectorAll('.button-group .btn').forEach(btn => {
                btn.classList.remove('active');
                btn.setAttribute('aria-pressed', 'false');
            });
            
            // Submit the form to refresh with no filters
            document.querySelector('.filter-form').submit();
        }

        // Function to properly submit filters with all checked values
        function submitFilters() {
            const form = document.querySelector('.filter-form');
            
            // Remove any existing hidden inputs to avoid duplicates
            const existingHiddenInputs = form.querySelectorAll('input[type="hidden"]');
            existingHiddenInputs.forEach(input => input.remove());
            
            // Collect all checked company checkboxes
            const checkedCompanies = document.querySelectorAll('input[name="company"]:checked');
            checkedCompanies.forEach(checkbox => {
                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = 'company';
                hiddenInput.value = checkbox.value;
                form.appendChild(hiddenInput);
            });
            
            // Collect all checked location checkboxes
            const checkedLocations = document.querySelectorAll('input[name="location"]:checked');
            checkedLocations.forEach(checkbox => {
                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'hidden';
                hiddenInput.name = 'location';
                hiddenInput.value = checkbox.value;
                form.appendChild(hiddenInput);
            });
            
            // Allow the form to submit normally
            return true;
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.dropdown')) {
                document.querySelectorAll('.dropdown-content').forEach(dropdown => {
                    dropdown.style.display = 'none';
                    // Clear search input and show all options when closing by clicking outside
                    const searchInput = dropdown.querySelector('.dropdown-search');
                    if (searchInput) {
                        searchInput.value = '';
                        filterDropdownOptions(dropdown.id);
                    }
                });
            }
        });

        // Function to filter dropdown options based on search input
        function filterDropdownOptions(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            const searchInput = dropdown.querySelector('.dropdown-search');
            const filter = searchInput.value.toUpperCase();
            const items = dropdown.querySelectorAll('.checkbox-item');

            items.forEach(item => {
                const text = item.textContent || item.innerText;
                if (text.toUpperCase().indexOf(filter) > -1) {
                    item.style.display = "";
                } else {
                    item.style.display = "none";
                }
            });
        }

        // Add event listeners to search inputs
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.dropdown-search').forEach(input => {
                input.addEventListener('input', function() {
                    filterDropdownOptions(this.closest('.dropdown-content').id);
                });
            });
        });

        // Function to set hidden input values for button groups
        function setHiddenInput(inputId, value) {
            const input = document.getElementById(inputId);
            if (input) {
                input.value = value;
                
                // Find the button group containing this input
                const form = input.closest('form');
                const fieldset = input.closest('fieldset');
                
                if (fieldset) {
                    // Update button appearance and aria-pressed states within this fieldset
                    const buttons = fieldset.querySelectorAll('[data-value]');
                    buttons.forEach(btn => {
                        btn.classList.remove('active');
                        btn.setAttribute('aria-pressed', 'false');
                        
                        if (btn.getAttribute('data-value') === value) {
                            btn.classList.add('active');
                            btn.setAttribute('aria-pressed', 'true');
                        }
                    });
                }
            }
        }

        // Initialize button states on page load
        document.addEventListener('DOMContentLoaded', function() {
            const dateFilter = document.getElementById('date_filter');
            const itemsPerPage = document.getElementById('items_per_page');
            
            if (dateFilter && dateFilter.value) {
                const fieldset = dateFilter.closest('fieldset');
                if (fieldset) {
                    const btn = fieldset.querySelector(`[data-value="${dateFilter.value}"]`);
                    if (btn) {
                        btn.classList.add('active');
                        btn.setAttribute('aria-pressed', 'true');
                    }
                }
            }
            
            if (itemsPerPage && itemsPerPage.value) {
                const fieldset = itemsPerPage.closest('fieldset');
                if (fieldset) {
                    const btn = fieldset.querySelector(`[data-value="${itemsPerPage.value}"]`);
                    if (btn) {
                        btn.classList.add('active');
                        btn.setAttribute('aria-pressed', 'true');
                    }
                }
            }
        });

        // Function to update city selection display
        function updateCitySelection() {
            const selectedRadio = document.querySelector('input[name="city"]:checked');
            const textElement = document.getElementById('city-selected-text');
            
            if (selectedRadio && selectedRadio.value) {
                textElement.textContent = selectedRadio.value;
            } else {
                textElement.textContent = 'Select City';
            }
        }

        // Function to update country selection display
        function updateCountrySelection() {
            const selectedRadio = document.querySelector('input[name="country"]:checked');
            const textElement = document.getElementById('country-selected-text');
            
            if (selectedRadio && selectedRadio.value) {
                textElement.textContent = selectedRadio.value;
            } else {
                textElement.textContent = 'Select Country';
            }
        }

        // Initialize city and country selection on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateCitySelection();
            updateCountrySelection();
        });
    </script>
</head>
<body>
    <div class="container">
        <header>
            <h1><span>role</span><span>/aggr</span></h1>
        </header>
        
        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="flash-messages">
                    {% for category, message in messages %}
                        <div class="flash-message flash-{{ category }}">{{ message }}</div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}
        
        <div class="controls">

            <div class="filter-section">
                <form action="/" method="get" class="filter-form" role="search" aria-label="Job search and filtering">
                    <div class="filter-grid">
                        <!-- Row 1: Search Input spanning all columns -->
                        <div class="search-group">
                            <input type="text" id="search" name="search" placeholder="Search jobs..." value="{{ request.args.get('search', '') }}" class="search-input">
                        </div>

                        <!-- Row 2: Individual filter columns -->
                        <!-- Column 1: Company Filter -->
                        <div class="dropdown form-group">
                            <div class="dropdown-toggle" onclick="toggleDropdown('company-dropdown')" aria-expanded="false">
                                <span id="company-selected-text">Select Companies</span>
                                <span class="dropdown-arrow">▼</span>
                            </div>
                            <div id="company-dropdown" class="dropdown-content">
                                <input type="text" class="dropdown-search" placeholder="Search companies..." oninput="filterDropdownOptions('company-dropdown')">
                                {% for available_company in available_companies %}
                                    <div class="checkbox-item">
                                        <input type="checkbox" name="company" value="{{ available_company }}" id="company-{{ loop.index }}" onchange="updateSelectedText('company')" {% if available_company in request.args.getlist('company') %}checked{% endif %}>
                                        <label for="company-{{ loop.index }}">{{ available_company }}</label>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Column 2: Location Filter -->
                        <div class="dropdown form-group">
                            <div class="dropdown-toggle" onclick="toggleDropdown('location-dropdown')" aria-expanded="false">
                                <span id="location-selected-text">Select Locations</span>
                                <span class="dropdown-arrow">▼</span>
                            </div>
                            <div id="location-dropdown" class="dropdown-content">
                                <input type="text" class="dropdown-search" placeholder="Search locations..." oninput="filterDropdownOptions('location-dropdown')">
                                {% for available_location in available_locations %}
                                    <div class="checkbox-item">
                                        <input type="checkbox" name="location" value="{{ available_location }}" id="location-{{ loop.index }}" onchange="updateSelectedText('location')" {% if available_location in request.args.getlist('location') %}checked{% endif %}>
                                        <label for="location-{{ loop.index }}">{{ available_location }}</label>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Column 3: City Filter -->
                        <div class="dropdown form-group">
                            <div class="dropdown-toggle" onclick="toggleDropdown('city-dropdown')" aria-expanded="false">
                                <span id="city-selected-text">{{ request.args.get('city', 'Select City') }}</span>
                                <span class="dropdown-arrow">▼</span>
                            </div>
                            <div id="city-dropdown" class="dropdown-content">
                                <input type="text" class="dropdown-search" placeholder="Search cities..." oninput="filterDropdownOptions('city-dropdown')">
                                <div class="checkbox-item">
                                    <input type="checkbox" name="city" value="" id="city-all" onchange="updateCitySelection()" {% if not request.args.get('city') %}checked{% endif %}>
                                    <label for="city-all">All Cities</label>
                                </div>
                                {% for available_city in available_cities %}
                                    <div class="checkbox-item">
                                        <input type="checkbox" name="city" value="{{ available_city }}" id="city-{{ loop.index }}" onchange="updateCitySelection()" {% if request.args.get('city') == available_city %}checked{% endif %}>
                                        <label for="city-{{ loop.index }}">{{ available_city }}</label>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Column 4: Country Filter -->
                        <div class="dropdown form-group">
                            <div class="dropdown-toggle" onclick="toggleDropdown('country-dropdown')" aria-expanded="false">
                                <span id="country-selected-text">{{ request.args.get('country', 'Select Country') }}</span>
                                <span class="dropdown-arrow">▼</span>
                            </div>
                            <div id="country-dropdown" class="dropdown-content">
                                <input type="text" class="dropdown-search" placeholder="Search countries..." oninput="filterDropdownOptions('country-dropdown')">
                                <div class="checkbox-item">
                                    <input type="checkbox" name="country" value="" id="country-all" onchange="updateCountrySelection()" {% if not request.args.get('country') %}checked{% endif %}>
                                    <label for="country-all">All Countries</label>
                                </div>
                                {% for available_country in available_countries %}
                                    <div class="checkbox-item">
                                        <input type="checkbox" name="country" value="{{ available_country }}" id="country-{{ loop.index }}" onchange="updateCountrySelection()" {% if request.args.get('country') == available_country %}checked{% endif %}>
                                        <label for="country-{{ loop.index }}">{{ available_country }}</label>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>

                        <!-- Column 5: Date Filter Button Group -->
                        <fieldset class="form-group">
                            <div class="button-group" role="radiogroup" aria-label="Select date filter">
                                <button type="button" class="btn" data-value="24h" aria-pressed="false" onclick="setHiddenInput('date_filter', '24h')">24h</button>
                                <button type="button" class="btn" data-value="7d" aria-pressed="false" onclick="setHiddenInput('date_filter', '7d')">7d</button>
                                <button type="button" class="btn" data-value="new" aria-pressed="false" onclick="setHiddenInput('date_filter', 'new')">New Jobs</button>
                            </div>
                            <input type="hidden" id="date_filter" name="date_filter" value="{{ request.args.get('date_filter', '') }}">
                        </fieldset>

                        <!-- Column 6: Items Per Page Button Group -->
                        <fieldset class="form-group">
                            <div class="button-group" role="radiogroup" aria-label="Select items per page">
                                <button type="button" class="btn" data-value="20" aria-pressed="false" onclick="setHiddenInput('items_per_page', '20')">20</button>
                                <button type="button" class="btn" data-value="50" aria-pressed="false" onclick="setHiddenInput('items_per_page', '50')">50</button>
                                <button type="button" class="btn" data-value="100" aria-pressed="false" onclick="setHiddenInput('items_per_page', '100')">100</button>
                            </div>
                            <input type="hidden" id="items_per_page" name="items_per_page" value="{{ request.args.get('items_per_page', '') }}">
                        </fieldset>

                        <!-- Column 7: Apply and Clear Buttons -->
                        <div class="form-group action-buttons">
                            <button type="submit" class="btn btn-primary" aria-label="Apply filters">Apply</button>
                            <button type="button" class="btn btn-secondary" aria-label="Clear all filters" onclick="clearFilters()">Clear</button>
                        </div>
                    </div>
                </form>
            </div>
            

        </div>
        
        <div class="loading">
            <div class="spinner"></div>
            <p>Loading job listings...</p>
        </div>
        
        <div class="job-listings" style="display: none;">
            {% if jobs %}
                {% for job in jobs %}
                    <a href="{{ job.url }}" class="job-card" target="_blank" rel="noopener noreferrer">
                        <div class="job-info">
                            <h2 class="job-title">{{ job.title }}
                                {% if job.is_new %}
                                    <span class="new-tag">[NEW]</span>
                                {% endif %}
                            </h2>
                            <div class="job-company">{{ job.company }}</div>
                            {% if job.city and job.country %}
                            <div class="job-location">Location: {{ job.city }}, {{ job.country }}</div>
                            {% elif job.city %}
                            <div class="job-location">Location: {{ job.city }}</div>
                            {% elif job.country %}
                            <div class="job-location">Location: {{ job.country }}</div>
                            {% elif job.location is defined and job.location != "N/A" %}
                            <div class="job-location">Location: {{ job.location }}</div>
                            {% else %}
                            <div class="job-location">Location: N/A</div>
                            {% endif %}
                            <div class="job-date">Posted: {{ job.date_posted }}</div>
                        </div>
                        <div class="job-meta">
                            <div class="job-source">{{ job.source }}</div>
                            <!-- Relevance Score Bar - Only show when search is active -->
                            {% if search_query and search_query.strip() %}
                            <div class="relevance-bar-container" title="Relevance Score: {{ job.relevance_score }}%">
                                <div class="relevance-bar"
                                     role="progressbar"
                                     aria-valuemin="0"
                                     aria-valuemax="100"
                                     aria-valuenow="{{ job.relevance_score }}"
                                     aria-label="Job relevance score"
                                     style="width: {{ job.relevance_score }}%"></div>
                            </div>
                            {% endif %}
                        </div>
                    </a>
                {% endfor %}
            {% else %}
                <div class="no-jobs">
                    <h2>No job listings found</h2>
                    <p>Try refreshing the listings or check back later.</p>
                </div>
            {% endif %}
        </div>
        <!-- Pagination Controls -->
        <div class="pagination">
            {% if pagination %}
                <nav aria-label="Pagination Navigation">
                    <ul class="pagination-list">
                        {% if pagination.prev_page %}
                            <li><a href="{{ url_for('index', **dict(request.args, page=pagination.prev_page)) }}">Previous</a></li>
                        {% endif %}
                        {% for page_num in pagination.pages %}
                            {% if page_num == '...' %}
                                <li class="ellipsis"><span>...</span></li>
                            {% else %}
                                <li {% if page_num == pagination.current_page %}class="active"{% endif %}><a href="{{ url_for('index', **dict(request.args, page=page_num)) }}">{{ page_num }}</a></li>
                            {% endif %}
                        {% endfor %}
                        {% if pagination.next_page %}
                            <li><a href="{{ url_for('index', **dict(request.args, page=pagination.next_page)) }}">Next</a></li>
                        {% endif %}
                    </ul>
                </nav>
            {% endif %}
        </div>
        
        <footer>
            <p>&copy; 2025 role/agg | Data sourced from various job boards</p>
        </footer>
    </div>
</body>
</html>